#!/usr/bin/env bash

# pls - PHP Local Server
# 
# Simple local development environment manager for PHP projects
# Caddy webserver + PHP-FPM + mkcert HTTPS

set -e

VERSION="1.0.0"

# === Configuration Variables ===
PLS_DIR="${PLS_DIR:-$HOME/.local/share/pls}"
PLS_CONFIG_DIR="${PLS_CONFIG_DIR:-$HOME/.config/pls}"
PLS_SITES_DIR="$PLS_CONFIG_DIR/sites"
PLS_CERTS_DIR="$PLS_CONFIG_DIR/certs"
PLS_LOG_DIR="$PLS_DIR/logs"
CADDYFILE="$PLS_CONFIG_DIR/Caddyfile"

PHP_DIR="${PHP_DIR:-$HOME/.local/php}"
PHP_VERSIONS_DIR="$PHP_DIR/versions"
PHP_RUN_DIR="$PHP_DIR/run"

PROJECTS_DIR="${PROJECTS_DIR:-$HOME/Codes}"

# System PHP version detection (pacman)
detect_system_php_version() {
    if command -v php &> /dev/null; then
        php -r 'echo PHP_MAJOR_VERSION . "." . PHP_MINOR_VERSION;' 2>/dev/null
    else
        echo "8.5"
    fi
}
DEFAULT_PHP_VERSION="${DEFAULT_PHP_VERSION:-$(detect_system_php_version)}"

CADDY_BIN="${CADDY_BIN:-/usr/sbin/caddy}"

# Static PHP download URL
STATIC_PHP_BASE_URL="https://dl.static-php.dev/static-php-cli/common"

# === Colors ===
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
CYAN=$'\033[0;36m'
BOLD=$'\033[1m'
NC=$'\033[0m'

# === Initialize directories ===
mkdir -p "$PLS_CONFIG_DIR" "$PLS_SITES_DIR" "$PLS_CERTS_DIR" "$PLS_LOG_DIR" "$PHP_RUN_DIR"

# === Helper functions ===

print_header() {
    echo -e "${BOLD}${CYAN}$1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_info() {
    echo -e "${BLUE}â†’${NC} $1"
}

# === Caddyfile initialization ===

init_caddyfile() {
    if [ ! -f "$CADDYFILE" ]; then
        cat > "$CADDYFILE" << EOF
{
    admin localhost:2019
    auto_https off
}

import $PLS_SITES_DIR/*.conf
EOF
        print_success "Caddyfile created"
    fi
}

# === Caddy management ===

caddy_is_running() {
    systemctl --user is-active --quiet pls-caddy.service 2>/dev/null
}

caddy_start() {
    if caddy_is_running; then
        print_warning "Caddy is already running"
        return 0
    fi

    init_caddyfile
    print_info "Starting Caddy..."
    systemctl --user start pls-caddy.service
    sleep 1

    if caddy_is_running; then
        print_success "Caddy started"
    else
        print_error "Failed to start Caddy"
        return 1
    fi
}

caddy_stop() {
    if ! caddy_is_running; then
        print_warning "Caddy is not running"
        return 0
    fi

    print_info "Stopping Caddy..."
    systemctl --user stop pls-caddy.service
    print_success "Caddy stopped"
}

caddy_reload() {
    if ! caddy_is_running; then
        print_error "Caddy is not running"
        return 1
    fi

    print_info "Reloading Caddy configuration..."
    systemctl --user reload pls-caddy.service
    print_success "Configuration reloaded"
}

# === PHP-FPM management ===

php_get_versions() {
    find "$PHP_VERSIONS_DIR" -maxdepth 1 -type d -name "php-*" 2>/dev/null | \
        sed 's|.*/php-||' | sort -V
}

php_is_running() {
    local version="$1"
    local pid_file="$PHP_RUN_DIR/php${version}-fpm.pid"

    if [ -f "$pid_file" ] && ps -p "$(cat "$pid_file")" > /dev/null 2>&1; then
        return 0
    fi
    return 1
}

php_start() {
    local version="$1"
    local version_dir="$PHP_VERSIONS_DIR/php-${version}"
    local fpm_bin="$version_dir/php-fpm"
    local fpm_conf="$version_dir/php-fpm.conf"

    if [ ! -x "$fpm_bin" ]; then
        print_error "PHP $version not found"
        return 1
    fi

    if php_is_running "$version"; then
        print_warning "PHP $version is already running"
        return 0
    fi

    print_info "Starting PHP $version FPM..."
    "$fpm_bin" --fpm-config "$fpm_conf" --daemonize
    print_success "PHP $version FPM started"
}

php_stop() {
    local version="$1"
    local pid_file="$PHP_RUN_DIR/php${version}-fpm.pid"

    if [ ! -f "$pid_file" ]; then
        print_warning "PHP $version is not running"
        return 0
    fi

    local pid=$(cat "$pid_file")
    print_info "Stopping PHP $version FPM..."
    kill "$pid" 2>/dev/null || true
    rm -f "$pid_file"
    print_success "PHP $version FPM stopped"
}

php_start_all() {
    for version in $(php_get_versions); do
        php_start "$version" 2>/dev/null || true
    done
}

php_stop_all() {
    for version in $(php_get_versions); do
        php_stop "$version" 2>/dev/null || true
    done
}

php_list() {
    echo ""
    print_header "PHP versions"
    echo ""

    local versions=$(php_get_versions)

    if [ -z "$versions" ]; then
        print_warning "No PHP version installed"
        echo "  Install: pls install php"
        return 0
    fi

    for version in $versions; do
        local version_dir="$PHP_VERSIONS_DIR/php-${version}"
        local php_full=$("$version_dir/php" -v 2>/dev/null | head -1 | cut -d' ' -f1-2 || echo "PHP $version")

        if php_is_running "$version"; then
            echo -e "  ${GREEN}â—${NC} ${BOLD}$php_full${NC} ${GREEN}[running]${NC}"
        else
            echo -e "  ${RED}â—${NC} $php_full ${YELLOW}[stopped]${NC}"
        fi
    done
    echo ""
}

# === Certificate management ===

generate_cert() {
    local hostname="$1"
    local cert_file="$PLS_CERTS_DIR/${hostname}.pem"
    local key_file="$PLS_CERTS_DIR/${hostname}-key.pem"

    if [ -f "$cert_file" ] && [ -f "$key_file" ]; then
        return 0
    fi

    if ! command -v mkcert &> /dev/null; then
        print_error "mkcert is not installed"
        echo "  Install: sudo pacman -S mkcert nss && mkcert -install"
        return 1
    fi

    print_info "Generating certificate: $hostname"
    mkcert -cert-file "$cert_file" -key-file "$key_file" \
        "$hostname" "*.${hostname}" localhost 127.0.0.1 ::1 > /dev/null 2>&1

    if [ -f "$cert_file" ]; then
        print_success "Certificate created"
    else
        print_error "Certificate generation failed"
        return 1
    fi
}

# === PHP version detection ===

detect_php_version() {
    local project_path="$1"
    local detected=""
    local source=""

    # 1. composer.json
    if [ -f "$project_path/composer.json" ]; then
        detected=$(grep -oP '"php"\s*:\s*"[^"]*(\d+\.\d+)' "$project_path/composer.json" 2>/dev/null | grep -oP '\d+\.\d+' | head -1)
        [ -n "$detected" ] && source="composer.json"
    fi

    # 2. .php-version
    if [ -z "$detected" ] && [ -f "$project_path/.php-version" ]; then
        detected=$(grep -oP '^\d+\.\d+' "$project_path/.php-version" 2>/dev/null | head -1)
        [ -n "$detected" ] && source=".php-version"
    fi

    # 3. .phpversion
    if [ -z "$detected" ] && [ -f "$project_path/.phpversion" ]; then
        detected=$(grep -oP '^\d+\.\d+' "$project_path/.phpversion" 2>/dev/null | head -1)
        [ -n "$detected" ] && source=".phpversion"
    fi

    if [ -n "$detected" ]; then
        echo "$detected|$source"
    else
        echo "$DEFAULT_PHP_VERSION|default"
    fi
}

# === Site management ===

serve_project() {
    local hostname="$1"
    local project_path=""
    local project_name=""

    # If not specified, use current folder
    if [ -z "$hostname" ]; then
        local current_dir=$(pwd)

        if [[ "$current_dir" == "$PROJECTS_DIR"/* ]]; then
            project_name=$(echo "$current_dir" | sed "s|$PROJECTS_DIR/||" | cut -d'/' -f1)
            project_path="$PROJECTS_DIR/$project_name"
            hostname="${project_name}.test"
        else
            print_error "Not in ~/Codes project folder"
            echo ""
            echo "  Usage:"
            echo "    cd ~/Codes/myproject && pls serve"
            echo "    pls serve myproject"
            return 1
        fi
    else
        # Handle .test suffix
        if [[ "$hostname" == *.test ]]; then
            project_name="${hostname%.test}"
        else
            project_name="$hostname"
            hostname="${project_name}.test"
        fi
        project_path="$PROJECTS_DIR/$project_name"
    fi

    # Does project exist?
    if [ ! -d "$project_path" ]; then
        print_error "Project not found: $project_path"
        echo ""
        cmd_projects
        return 1
    fi

    local site_file="$PLS_SITES_DIR/${hostname}.conf"

    if [ -f "$site_file" ]; then
        print_warning "Site already exists: $hostname"
        return 1
    fi

    # PHP version
    local php_info=$(detect_php_version "$project_path")
    local php_version=$(echo "$php_info" | cut -d'|' -f1)
    local php_source=$(echo "$php_info" | cut -d'|' -f2)

    # Document root
    local doc_root="$project_path"
    [ -d "$project_path/public" ] && doc_root="$project_path/public"
    [ -d "$project_path/web" ] && doc_root="$project_path/web"

    # PHP socket
    local php_socket=""
    if [ -S "$PHP_RUN_DIR/php${php_version}-fpm.sock" ]; then
        php_socket="unix/$PHP_RUN_DIR/php${php_version}-fpm.sock"
    else
        print_error "PHP $php_version FPM is not running"
        echo "  Start it: pls start"
        return 1
    fi

    generate_cert "$hostname" || return 1

    cat > "$site_file" << EOF
https://${hostname} {
    tls $PLS_CERTS_DIR/${hostname}.pem $PLS_CERTS_DIR/${hostname}-key.pem
    root * ${doc_root}
    php_fastcgi ${php_socket}
    file_server
    log {
        output file $PLS_LOG_DIR/${hostname}.log
    }
    @phpFiles path *.php
    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}
EOF

    echo ""
    print_success "Site created: $project_name"
    echo -e "  ${BLUE}URL:${NC}  https://${hostname}"
    echo -e "  ${BLUE}PHP:${NC}  $php_version ($php_source)"
    echo -e "  ${BLUE}Root:${NC} $doc_root"

    if caddy_is_running; then
        caddy_reload
    else
        print_warning "Caddy is not running. Start it: pls start"
    fi
}

remove_site() {
    local hostname="$1"

    if [ -z "$hostname" ]; then
        print_error "Usage: pls remove <hostname>"
        return 1
    fi

    [[ "$hostname" != *.test ]] && hostname="${hostname}.test"

    local site_file="$PLS_SITES_DIR/${hostname}.conf"

    if [ ! -f "$site_file" ]; then
        print_error "Site not found: $hostname"
        return 1
    fi

    rm -f "$site_file"
    rm -f "$PLS_CERTS_DIR/${hostname}.pem" "$PLS_CERTS_DIR/${hostname}-key.pem"

    print_success "Site removed: $hostname"

    caddy_is_running && caddy_reload
}

list_sites() {
    echo ""
    print_header "Active sites"
    echo ""

    local count=$(find "$PLS_SITES_DIR" -name "*.conf" 2>/dev/null | wc -l)

    if [ "$count" -eq 0 ]; then
        print_warning "No sites configured"
        echo "  Create one: cd ~/Codes/myproject && pls serve"
        echo ""
        return 0
    fi

    for site_file in "$PLS_SITES_DIR"/*.conf; do
        [ -f "$site_file" ] || continue

        local hostname=$(basename "$site_file" .conf)
        local backend=""

        if grep -q "php_fastcgi" "$site_file"; then
            local php_ver=$(grep -oP 'php\K[0-9.]+' "$site_file" | head -1)
            backend="PHP $php_ver"
        else
            backend=$(grep -oP 'reverse_proxy \K[^\s]+' "$site_file" | head -1)
        fi

        echo -e "  ${GREEN}ðŸ”’${NC} ${BOLD}https://${hostname}${NC} â†’ $backend"
    done
    echo ""
}

# === Commands ===

cmd_start() {
    echo ""
    print_header "Starting PHP Local Server"
    echo ""

    # Start PHP-FPM
    php_start_all

    # Start Caddy
    caddy_start

    echo ""
    print_success "Environment started"
    echo ""
}

cmd_stop() {
    echo ""
    print_header "Stopping PHP Local Server"
    echo ""

    caddy_stop
    php_stop_all

    echo ""
    print_success "Environment stopped"
    echo ""
}

cmd_restart() {
    cmd_stop
    sleep 1
    cmd_start
}

cmd_status() {
    echo ""
    print_header "PHP Local Server"
    echo ""

    # Caddy status
    echo -n "  Caddy:   "
    if caddy_is_running; then
        echo -e "${GREEN}â—${NC} running"
    else
        echo -e "${RED}â—${NC} stopped"
    fi

    # PHP status
    local php_running=0
    local php_total=0
    for version in $(php_get_versions); do
        php_total=$((php_total + 1))
        php_is_running "$version" && php_running=$((php_running + 1)) || true
    done

    echo -n "  PHP-FPM: "
    if [ "$php_running" -eq "$php_total" ] && [ "$php_total" -gt 0 ]; then
        echo -e "${GREEN}â—${NC} $php_running/$php_total running"
    elif [ "$php_running" -gt 0 ]; then
        echo -e "${YELLOW}â—${NC} $php_running/$php_total running"
    else
        echo -e "${RED}â—${NC} stopped"
    fi

    # Sites
    local site_count=$(find "$PLS_SITES_DIR" -name "*.conf" 2>/dev/null | wc -l)
    echo -e "  Sites:   $site_count active"

    list_sites
}

cmd_projects() {
    echo ""
    print_header "Projects ($PROJECTS_DIR)"
    echo ""

    if [ ! -d "$PROJECTS_DIR" ]; then
        print_error "Project folder does not exist: $PROJECTS_DIR"
        return 1
    fi

    local projects=$(find "$PROJECTS_DIR" -maxdepth 1 -type d -not -path "$PROJECTS_DIR" -printf "%f\n" 2>/dev/null | sort)

    if [ -z "$projects" ]; then
        print_warning "No projects found"
        return 0
    fi

    for project in $projects; do
        local served=""
        [ -f "$PLS_SITES_DIR/${project}.test.conf" ] && served=" ${GREEN}[active]${NC}"
        echo -e "  ${BLUE}â€¢${NC} $project$served"
    done
    echo ""
}

# Find PHP binary by version
php_get_bin() {
    local version="$1"
    local php_bin="$PHP_VERSIONS_DIR/php-${version}/php"

    if [ -x "$php_bin" ]; then
        echo "$php_bin"
    elif command -v php &> /dev/null; then
        command -v php
    else
        return 1
    fi
}

# Detect PHP version from current directory
php_detect_current() {
    local detected=""
    local source=""

    # 1. composer.json
    if [ -f "composer.json" ]; then
        detected=$(grep -oP '"php"\s*:\s*"[^"]*(\d+\.\d+)' "composer.json" 2>/dev/null | grep -oP '\d+\.\d+' | head -1)
        [ -n "$detected" ] && source="composer.json"
    fi

    # 2. .php-version
    if [ -z "$detected" ] && [ -f ".php-version" ]; then
        detected=$(grep -oP '^\d+\.\d+' ".php-version" 2>/dev/null | head -1)
        [ -n "$detected" ] && source=".php-version"
    fi

    # 3. .phpversion
    if [ -z "$detected" ] && [ -f ".phpversion" ]; then
        detected=$(grep -oP '^\d+\.\d+' ".phpversion" 2>/dev/null | head -1)
        [ -n "$detected" ] && source=".phpversion"
    fi

    if [ -n "$detected" ]; then
        echo "$detected|$source"
    else
        echo "$DEFAULT_PHP_VERSION|default"
    fi
}

# Run PHP CLI with appropriate version
php_run() {
    local php_info=$(php_detect_current)
    local php_version=$(echo "$php_info" | cut -d'|' -f1)
    local php_source=$(echo "$php_info" | cut -d'|' -f2)
    local php_bin=$(php_get_bin "$php_version")

    if [ -z "$php_bin" ]; then
        print_error "PHP $php_version not found"
        return 1
    fi

    # If no arguments, show version with source
    if [ $# -eq 0 ]; then
        echo -e "${BLUE}PHP $php_version${NC} ($php_source)"
        "$php_bin" -v
        return 0
    fi

    # Run PHP with arguments
    exec "$php_bin" "$@"
}

cmd_php() {
    local subcmd="${1:-}"

    # FPM management commands
    case "$subcmd" in
        list|ls)
            php_list
            return
            ;;
        fpm)
            shift
            local fpm_cmd="${1:-list}"
            shift 2>/dev/null || true
            case "$fpm_cmd" in
                start)
                    if [ -z "$1" ]; then
                        php_start_all
                    else
                        php_start "$1"
                    fi
                    ;;
                stop)
                    if [ -z "$1" ]; then
                        php_stop_all
                    else
                        php_stop "$1"
                    fi
                    ;;
                restart)
                    if [ -z "$1" ]; then
                        php_stop_all
                        sleep 1
                        php_start_all
                    else
                        php_stop "$1"
                        sleep 1
                        php_start "$1"
                    fi
                    ;;
                *)
                    php_list
                    ;;
            esac
            return
            ;;
        start)
            shift
            if [ -z "$1" ]; then
                php_start_all
            else
                php_start "$1"
            fi
            return
            ;;
        stop)
            shift
            if [ -z "$1" ]; then
                php_stop_all
            else
                php_stop "$1"
            fi
            return
            ;;
        restart)
            shift
            if [ -z "$1" ]; then
                php_stop_all
                sleep 1
                php_start_all
            else
                php_stop "$1"
                sleep 1
                php_start "$1"
            fi
            return
            ;;
    esac

    # If not FPM command, use CLI wrapper
    php_run "$@"
}

# Run Composer with appropriate PHP version
cmd_composer() {
    local php_info=$(php_detect_current)
    local php_version=$(echo "$php_info" | cut -d'|' -f1)
    local php_source=$(echo "$php_info" | cut -d'|' -f2)
    local php_bin=$(php_get_bin "$php_version")

    if [ -z "$php_bin" ]; then
        print_error "PHP $php_version not found"
        return 1
    fi

    # Find Composer
    local composer_bin=""

    # 1. Project local composer.phar
    if [ -f "composer.phar" ]; then
        composer_bin="composer.phar"
    # 2. System composer
    elif command -v composer &> /dev/null; then
        composer_bin=$(command -v composer)
    # 3. ~/.local/bin/composer
    elif [ -x "$HOME/.local/bin/composer" ]; then
        composer_bin="$HOME/.local/bin/composer"
    # 4. Global composer.phar
    elif [ -f "$HOME/.composer/composer.phar" ]; then
        composer_bin="$HOME/.composer/composer.phar"
    else
        print_error "Composer not found"
        echo "  Install: https://getcomposer.org/download/"
        return 1
    fi

    # If no arguments, show version
    if [ $# -eq 0 ]; then
        echo -e "${BLUE}Composer${NC} + PHP $php_version ($php_source)"
        exec "$php_bin" "$composer_bin" --version
    fi

    # Run Composer
    exec "$php_bin" "$composer_bin" "$@"
}

cmd_logs() {
    local target="${1:-caddy}"

    case "$target" in
        caddy)
            journalctl --user -u pls-caddy.service -f
            ;;
        php)
            tail -f "$PHP_DIR"/logs/*.log 2>/dev/null || print_warning "No PHP logs"
            ;;
        *)
            # Site log
            local logfile="$PLS_LOG_DIR/${target}.log"
            [ ! -f "$logfile" ] && logfile="$PLS_LOG_DIR/${target}.test.log"

            if [ -f "$logfile" ]; then
                tail -f "$logfile"
            else
                print_error "Log not found: $target"
            fi
            ;;
    esac
}

# === INSTALL COMMAND ===

install_directories() {
    print_info "Creating directories..."
    mkdir -p "$PLS_CONFIG_DIR" "$PLS_SITES_DIR" "$PLS_CERTS_DIR" "$PLS_LOG_DIR"
    mkdir -p "$PHP_DIR" "$PHP_VERSIONS_DIR" "$PHP_RUN_DIR" "$PHP_DIR/logs"
    mkdir -p "$PROJECTS_DIR"
    mkdir -p "$HOME/.config/systemd/user"
    mkdir -p "$HOME/.local/bin"
    print_success "Directories created"
}

install_check_deps() {
    local missing=()

    command -v curl &> /dev/null || missing+=("curl")
    command -v tar &> /dev/null || missing+=("tar")

    if [ ${#missing[@]} -gt 0 ]; then
        print_error "Missing dependencies: ${missing[*]}"
        echo "  Install: sudo pacman -S ${missing[*]}"
        return 1
    fi
    return 0
}

install_caddy() {
    echo ""
    print_header "Installing Caddy"

    if [ -x "$CADDY_BIN" ]; then
        print_success "Caddy already installed: $("$CADDY_BIN" version 2>/dev/null | head -1)"
    else
        print_info "Installing Caddy..."
        sudo pacman -S --needed --noconfirm caddy || {
            print_error "Failed to install Caddy"
            return 1
        }
    fi

    # Set capability for ports 80/443
    print_info "Setting port capability..."
    sudo setcap 'cap_net_bind_service=+ep' "$CADDY_BIN" 2>/dev/null || {
        print_warning "Failed to set capability (sudo required)"
    }

    # Systemd service
    print_info "Creating systemd service..."
    cat > "$HOME/.config/systemd/user/pls-caddy.service" << 'EOF'
[Unit]
Description=Caddy Web Server (pls)
After=network.target

[Service]
Type=simple
ExecStart=/usr/sbin/caddy run --config %h/.config/pls/Caddyfile --adapter caddyfile
ExecReload=/usr/bin/curl -s http://localhost:2019/load -H "Content-Type: text/caddyfile" --data-binary @%h/.config/pls/Caddyfile
Restart=on-failure
RestartSec=5

[Install]
WantedBy=default.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable pls-caddy.service 2>/dev/null || true

    # Initialize Caddyfile
    init_caddyfile

    print_success "Caddy configured"
}

install_mkcert() {
    echo ""
    print_header "Installing mkcert (HTTPS)"

    if command -v mkcert &> /dev/null; then
        print_success "mkcert already installed"
    else
        print_info "Installing mkcert..."
        sudo pacman -S --needed --noconfirm mkcert nss || {
            print_error "Failed to install mkcert"
            return 1
        }
    fi

    # Initialize CA
    if [ ! -d "$(mkcert -CAROOT 2>/dev/null)" ] || [ ! -f "$(mkcert -CAROOT)/rootCA.pem" ]; then
        print_info "Initializing local CA..."
        mkcert -install
    fi

    print_success "mkcert configured"
}

install_dnsmasq() {
    echo ""
    print_header "Installing dnsmasq (.test domain)"

    if command -v dnsmasq &> /dev/null; then
        print_success "dnsmasq already installed"
    else
        print_info "Installing dnsmasq..."
        sudo pacman -S --needed --noconfirm dnsmasq || {
            print_error "Failed to install dnsmasq"
            return 1
        }
    fi

    # .test domain configuration
    local dnsmasq_conf="/etc/dnsmasq.d/test-tld.conf"
    if [ ! -f "$dnsmasq_conf" ]; then
        print_info "Configuring .test domain..."
        echo "address=/test/127.0.0.1" | sudo tee "$dnsmasq_conf" > /dev/null
        sudo systemctl enable dnsmasq
        sudo systemctl restart dnsmasq
    fi

    # resolv.conf check
    if ! grep -q "127.0.0.1" /etc/resolv.conf 2>/dev/null; then
        print_warning "Add 127.0.0.1 to /etc/resolv.conf"
        echo "  nameserver 127.0.0.1"
    fi

    print_success "dnsmasq configured"
}

# Get full PHP version from major.minor (fetched dynamically or use known latest)
get_php_full_version() {
    local version="$1"

    # Try to get latest version from static-php.dev
    local latest=$(curl -sL "${STATIC_PHP_BASE_URL}/" 2>/dev/null | \
        grep -oP "php-${version}\.[0-9]+-fpm-linux-x86_64" | \
        sort -V | tail -1 | grep -oP "${version}\.[0-9]+")

    if [ -n "$latest" ]; then
        echo "$latest"
        return
    fi

    # Fallback to known versions
    case "$version" in
        8.1) echo "8.1.34" ;;
        8.2) echo "8.2.30" ;;
        8.3) echo "8.3.30" ;;
        8.4) echo "8.4.17" ;;
        *) echo "" ;;
    esac
}

install_php_version() {
    local version="$1"
    local version_dir="$PHP_VERSIONS_DIR/php-${version}"

    if [ -d "$version_dir" ] && [ -x "$version_dir/php" ] && [ -x "$version_dir/php-fpm" ]; then
        print_warning "PHP $version already installed"
        return 0
    fi

    local full_version=$(get_php_full_version "$version")
    if [ -z "$full_version" ]; then
        print_error "Unknown PHP version: $version"
        return 1
    fi

    print_info "Downloading PHP $full_version..."

    local arch="x86_64"
    local tmp_dir=$(mktemp -d)
    mkdir -p "$version_dir"

    # Download CLI version
    local cli_url="${STATIC_PHP_BASE_URL}/php-${full_version}-cli-linux-${arch}.tar.gz"
    local cli_file="$tmp_dir/cli.tar.gz"

    print_info "Downloading CLI: $cli_url"
    if curl -fsSL "$cli_url" -o "$cli_file" 2>/dev/null; then
        tar -xzf "$cli_file" -C "$tmp_dir" 2>/dev/null
        if [ -f "$tmp_dir/php" ]; then
            cp "$tmp_dir/php" "$version_dir/php"
            chmod +x "$version_dir/php"
            print_success "PHP CLI installed"
        fi
        rm -f "$cli_file"
        rm -f "$tmp_dir/php" "$tmp_dir/LICENSE" 2>/dev/null
    else
        print_warning "CLI download failed, will use system PHP as fallback"
    fi

    # Download FPM version
    local fpm_url="${STATIC_PHP_BASE_URL}/php-${full_version}-fpm-linux-${arch}.tar.gz"
    local fpm_file="$tmp_dir/fpm.tar.gz"

    print_info "Downloading FPM: $fpm_url"
    if curl -fsSL "$fpm_url" -o "$fpm_file" 2>/dev/null; then
        tar -xzf "$fpm_file" -C "$tmp_dir" 2>/dev/null
        if [ -f "$tmp_dir/php-fpm" ]; then
            cp "$tmp_dir/php-fpm" "$version_dir/php-fpm"
            chmod +x "$version_dir/php-fpm"
            print_success "PHP-FPM installed"
        fi
        # If CLI wasn't available, use php from FPM package if present
        if [ ! -x "$version_dir/php" ] && [ -f "$tmp_dir/php" ]; then
            cp "$tmp_dir/php" "$version_dir/php"
            chmod +x "$version_dir/php"
        fi
    else
        print_error "FPM download failed for PHP $version"
        rm -rf "$tmp_dir"
        return 1
    fi

    rm -rf "$tmp_dir"

    # PHP-FPM configuration
    install_php_fpm_config "$version"

    print_success "PHP $full_version installed"
}

install_php_fpm_config() {
    local version="$1"
    local version_dir="$PHP_VERSIONS_DIR/php-${version}"
    local fpm_conf="$version_dir/php-fpm.conf"
    local pool_conf="$version_dir/php-fpm.d/www.conf"

    mkdir -p "$version_dir/php-fpm.d"

    # Main FPM config
    cat > "$fpm_conf" << EOF
[global]
pid = $PHP_RUN_DIR/php${version}-fpm.pid
error_log = $PHP_DIR/logs/php${version}-fpm.log
daemonize = yes

include = $version_dir/php-fpm.d/*.conf
EOF

    # Pool config
    cat > "$pool_conf" << EOF
[www]
user = $USER
group = $USER

listen = $PHP_RUN_DIR/php${version}-fpm.sock
listen.owner = $USER
listen.group = $USER
listen.mode = 0660

pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3

catch_workers_output = yes
EOF
}

install_php_all() {
    echo ""
    print_header "Installing PHP versions"

    local versions=("8.1" "8.2" "8.3" "8.4")

    for version in "${versions[@]}"; do
        install_php_version "$version" || true
    done

    # Systemd service
    print_info "Creating PHP-FPM systemd service..."
    cat > "$HOME/.config/systemd/user/pls-php.service" << 'EOF'
[Unit]
Description=PHP-FPM (pls)
After=network.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=%h/.local/bin/pls php start
ExecStop=%h/.local/bin/pls php stop

[Install]
WantedBy=default.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable pls-php.service 2>/dev/null || true

    print_success "PHP-FPM configured"
}

install_composer() {
    echo ""
    print_header "Installing Composer"

    local composer_bin="$HOME/.local/bin/composer"

    if [ -x "$composer_bin" ]; then
        print_success "Composer already installed: $("$composer_bin" --version 2>/dev/null | head -1)"
        return 0
    fi

    if command -v composer &> /dev/null; then
        print_success "Composer already installed (system): $(composer --version 2>/dev/null | head -1)"
        return 0
    fi

    print_info "Downloading Composer..."

    local php_bin=$(php_get_bin "$DEFAULT_PHP_VERSION")
    [ -z "$php_bin" ] && php_bin="php"

    curl -sS https://getcomposer.org/installer | "$php_bin" -- --install-dir="$HOME/.local/bin" --filename=composer || {
        print_error "Failed to install Composer"
        return 1
    }

    chmod +x "$composer_bin"
    print_success "Composer installed: $HOME/.local/bin/composer"
}

install_linger() {
    echo ""
    print_header "Enabling systemd linger (boot autostart)"

    if loginctl show-user "$USER" 2>/dev/null | grep -q "Linger=yes"; then
        print_success "Linger already enabled"
    else
        print_info "Enabling linger..."
        loginctl enable-linger "$USER" || sudo loginctl enable-linger "$USER" || {
            print_warning "Failed to enable linger"
            return 1
        }
        print_success "Linger enabled"
    fi
}

install_shell_aliases() {
    echo ""
    print_header "Shell aliases"

    echo ""
    echo "Add to your shell configuration (~/.bashrc or ~/.zshrc):"
    echo ""
    echo -e "  ${CYAN}# pls - PHP Local Server${NC}"
    echo -e "  ${CYAN}alias php=\"pls php\"${NC}"
    echo -e "  ${CYAN}alias composer=\"pls composer\"${NC}"
    echo ""
}

cmd_deps() {
    echo "caddy mkcert nss dnsmasq curl tar"
}

cmd_install() {
    local component="${1:-all}"

    echo ""
    print_header "pls - PHP Local Server Installer"
    echo ""

    case "$component" in
        all)
            install_check_deps || return 1
            install_directories
            install_caddy
            install_mkcert
            install_dnsmasq
            install_php_all
            install_composer
            install_linger

            echo ""
            print_header "Installation complete!"
            echo ""
            echo "  Start:   pls start"
            echo "  Status:  pls status"
            echo "  Project: cd ~/Codes/myapp && pls serve"
            echo ""

            install_shell_aliases
            ;;
        php)
            shift 2>/dev/null || true
            if [ -n "$1" ]; then
                install_php_version "$1"
            else
                install_php_all
            fi
            ;;
        caddy)
            install_caddy
            ;;
        mkcert)
            install_mkcert
            ;;
        dnsmasq|dns)
            install_dnsmasq
            ;;
        composer)
            install_composer
            ;;
        *)
            echo "Usage: pls install [component]"
            echo ""
            echo "Components:"
            echo "  all       Full installation (default)"
            echo "  php [ver] PHP versions (or a specific one)"
            echo "  caddy     Caddy webserver"
            echo "  mkcert    mkcert (HTTPS)"
            echo "  dnsmasq   dnsmasq (.test domain)"
            echo "  composer  Composer"
            ;;
    esac
}

cmd_help() {
    cat <<EOF
${BOLD}${CYAN}pls${NC} - PHP Local Server v${VERSION}

${BOLD}USAGE${NC}
  pls <command> [options]

${BOLD}ENVIRONMENT MANAGEMENT${NC}
  ${BLUE}start${NC}              Start all services (Caddy + PHP-FPM)
  ${BLUE}stop${NC}               Stop all services
  ${BLUE}restart${NC}            Restart
  ${BLUE}status${NC}             Show status

${BOLD}SITE MANAGEMENT${NC}
  ${BLUE}serve${NC} [project]    Serve project (or current folder)
  ${BLUE}remove${NC} <host>      Remove site
  ${BLUE}list${NC}               List active sites
  ${BLUE}projects${NC}           List available projects

${BOLD}PHP & COMPOSER (alias php="pls php" composer="pls composer")${NC}
  ${BLUE}php${NC}                Show PHP version (based on project)
  ${BLUE}php${NC} <args>         Run PHP with appropriate version
  ${BLUE}php artisan${NC} ...    Laravel Artisan
  ${BLUE}composer${NC}           Composer version (with project PHP)
  ${BLUE}composer${NC} <args>    Run Composer (install, update, etc.)

${BOLD}PHP-FPM MANAGEMENT${NC}
  ${BLUE}php list${NC}           List installed PHP versions
  ${BLUE}php start${NC} [ver]    Start PHP-FPM
  ${BLUE}php stop${NC} [ver]     Stop PHP-FPM
  ${BLUE}php restart${NC} [ver]  Restart PHP-FPM

${BOLD}INSTALLATION${NC}
  ${BLUE}install${NC}            Full environment installation
  ${BLUE}install php${NC} [ver]  Install PHP versions
  ${BLUE}install composer${NC}   Install Composer

${BOLD}OTHER${NC}
  ${BLUE}logs${NC} [target]      Show logs (caddy/php/site)
  ${BLUE}help${NC}               Show help
  ${BLUE}version${NC}            Show version

${BOLD}EXAMPLES${NC}
  pls start                      # Start environment
  cd ~/Codes/myapp && pls serve  # Serve project
  pls serve myapp                # Serve project by name

  cd ~/Codes/myapp && pls php    # PHP version (8.4 if in composer.json)
  pls php artisan migrate        # Laravel migration with correct PHP
  pls composer install           # Composer with correct PHP
  pls composer update            # Composer update

  pls php list                   # PHP-FPM versions
  pls logs myapp.test            # Site log

${BOLD}PHP VERSION DETECTION${NC}
  1. composer.json require.php
  2. .php-version file
  3. .phpversion file
  4. Default: $DEFAULT_PHP_VERSION

${BOLD}FILES${NC}
  Config:   $PLS_CONFIG_DIR
  Sites:    $PLS_SITES_DIR
  Certs:    $PLS_CERTS_DIR
  Logs:     $PLS_LOG_DIR
  PHP:      $PHP_DIR
  Projects: $PROJECTS_DIR
EOF
}

# === Main entry point ===

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true

    case "$cmd" in
        start)          cmd_start ;;
        stop)           cmd_stop ;;
        restart)        cmd_restart ;;
        status|st)      cmd_status ;;
        serve)          serve_project "$@" ;;
        remove|rm)      remove_site "$@" ;;
        list|ls)        list_sites ;;
        sites)          list_sites ;;
        projects|proj)  cmd_projects ;;
        php)            cmd_php "$@" ;;
        composer)       cmd_composer "$@" ;;
        install)        cmd_install "$@" ;;
        logs|log)       cmd_logs "$@" ;;
        reload)         caddy_reload ;;
        help|--help|-h) cmd_help ;;
        version|-v|--version) echo "pls version $VERSION" ;;
        *)
            print_error "Unknown command: $cmd"
            echo "  Usage: pls help"
            exit 1
            ;;
    esac
}

main "$@"
