#!/usr/bin/env bash

# ld - Local Development Environment Manager
# https://github.com/yourusername/ld
#
# Egyszer≈± helyi fejleszt≈ëi k√∂rnyezet kezel≈ë PHP projektekhez
# Caddy webszerver + PHP-FPM + mkcert HTTPS

set -e

VERSION="1.0.0"

# === Konfigur√°ci√≥s v√°ltoz√≥k ===
LD_DIR="${LD_DIR:-$HOME/.local/share/ld}"
LD_CONFIG_DIR="${LD_CONFIG_DIR:-$HOME/.config/ld}"
LD_SITES_DIR="$LD_CONFIG_DIR/sites"
LD_CERTS_DIR="$LD_CONFIG_DIR/certs"
LD_LOG_DIR="$LD_DIR/logs"
CADDYFILE="$LD_CONFIG_DIR/Caddyfile"

PHP_DIR="${PHP_DIR:-$HOME/.local/php}"
PHP_VERSIONS_DIR="$PHP_DIR/versions"
PHP_RUN_DIR="$PHP_DIR/run"

PROJECTS_DIR="${PROJECTS_DIR:-$HOME/Codes}"

# Rendszer PHP verzi√≥ detekt√°l√°sa (pacman)
detect_system_php_version() {
    if command -v php &> /dev/null; then
        php -r 'echo PHP_MAJOR_VERSION . "." . PHP_MINOR_VERSION;' 2>/dev/null
    else
        echo "8.5"
    fi
}
DEFAULT_PHP_VERSION="${DEFAULT_PHP_VERSION:-$(detect_system_php_version)}"

CADDY_BIN="${CADDY_BIN:-/usr/sbin/caddy}"

# Static PHP let√∂lt√©si URL-ek
STATIC_PHP_BASE_URL="https://dl.static-php.dev/static-php-cli/common"

# === Sz√≠nek ===
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
CYAN=$'\033[0;36m'
BOLD=$'\033[1m'
NC=$'\033[0m'

# === K√∂nyvt√°rak inicializ√°l√°sa ===
mkdir -p "$LD_CONFIG_DIR" "$LD_SITES_DIR" "$LD_CERTS_DIR" "$LD_LOG_DIR" "$PHP_RUN_DIR"

# === Seg√©df√ºggv√©nyek ===

print_header() {
    echo -e "${BOLD}${CYAN}$1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úì${NC} $1"
}

print_error() {
    echo -e "${RED}‚úó${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

print_info() {
    echo -e "${BLUE}‚Üí${NC} $1"
}

# === Caddyfile inicializ√°l√°s ===

init_caddyfile() {
    if [ ! -f "$CADDYFILE" ]; then
        cat > "$CADDYFILE" << EOF
{
    admin localhost:2019
    auto_https off
}

import $LD_SITES_DIR/*.conf
EOF
        print_success "Caddyfile l√©trehozva"
    fi
}

# === Caddy kezel√©s ===

caddy_is_running() {
    systemctl --user is-active --quiet caddy.service 2>/dev/null
}

caddy_start() {
    if caddy_is_running; then
        print_warning "Caddy m√°r fut"
        return 0
    fi

    init_caddyfile
    print_info "Caddy ind√≠t√°sa..."
    systemctl --user start caddy.service
    sleep 1

    if caddy_is_running; then
        print_success "Caddy elindult"
    else
        print_error "Caddy ind√≠t√°sa sikertelen"
        return 1
    fi
}

caddy_stop() {
    if ! caddy_is_running; then
        print_warning "Caddy nem fut"
        return 0
    fi

    print_info "Caddy le√°ll√≠t√°sa..."
    systemctl --user stop caddy.service
    print_success "Caddy le√°ll√≠tva"
}

caddy_reload() {
    if ! caddy_is_running; then
        print_error "Caddy nem fut"
        return 1
    fi

    print_info "Caddy konfigur√°ci√≥ √∫jrat√∂lt√©se..."
    systemctl --user reload caddy.service
    print_success "Konfigur√°ci√≥ √∫jrat√∂ltve"
}

# === PHP-FPM kezel√©s ===

php_get_versions() {
    find "$PHP_VERSIONS_DIR" -maxdepth 1 -type d -name "php-*" 2>/dev/null | \
        sed 's|.*/php-||' | sort -V
}

php_is_running() {
    local version="$1"
    local pid_file="$PHP_RUN_DIR/php${version}-fpm.pid"

    if [ -f "$pid_file" ] && ps -p "$(cat "$pid_file")" > /dev/null 2>&1; then
        return 0
    fi
    return 1
}

php_start() {
    local version="$1"
    local version_dir="$PHP_VERSIONS_DIR/php-${version}"
    local fpm_bin="$version_dir/php-fpm"
    local fpm_conf="$version_dir/php-fpm.conf"

    if [ ! -x "$fpm_bin" ]; then
        print_error "PHP $version nem tal√°lhat√≥"
        return 1
    fi

    if php_is_running "$version"; then
        print_warning "PHP $version m√°r fut"
        return 0
    fi

    print_info "PHP $version FPM ind√≠t√°sa..."
    "$fpm_bin" --fpm-config "$fpm_conf" --daemonize
    print_success "PHP $version FPM elindult"
}

php_stop() {
    local version="$1"
    local pid_file="$PHP_RUN_DIR/php${version}-fpm.pid"

    if [ ! -f "$pid_file" ]; then
        print_warning "PHP $version nem fut"
        return 0
    fi

    local pid=$(cat "$pid_file")
    print_info "PHP $version FPM le√°ll√≠t√°sa..."
    kill "$pid" 2>/dev/null || true
    rm -f "$pid_file"
    print_success "PHP $version FPM le√°ll√≠tva"
}

php_start_all() {
    for version in $(php_get_versions); do
        php_start "$version" 2>/dev/null || true
    done
}

php_stop_all() {
    for version in $(php_get_versions); do
        php_stop "$version" 2>/dev/null || true
    done
}

php_list() {
    echo ""
    print_header "PHP verzi√≥k"
    echo ""

    local versions=$(php_get_versions)

    if [ -z "$versions" ]; then
        print_warning "Nincs telep√≠tett PHP verzi√≥"
        echo "  Telep√≠t√©s: ld install php"
        return 0
    fi

    for version in $versions; do
        local version_dir="$PHP_VERSIONS_DIR/php-${version}"
        local php_full=$("$version_dir/php" -v 2>/dev/null | head -1 | cut -d' ' -f1-2 || echo "PHP $version")

        if php_is_running "$version"; then
            echo -e "  ${GREEN}‚óè${NC} ${BOLD}$php_full${NC} ${GREEN}[fut√≥]${NC}"
        else
            echo -e "  ${RED}‚óè${NC} $php_full ${YELLOW}[le√°ll√≠tva]${NC}"
        fi
    done
    echo ""
}

# === Tan√∫s√≠tv√°ny kezel√©s ===

generate_cert() {
    local hostname="$1"
    local cert_file="$LD_CERTS_DIR/${hostname}.pem"
    local key_file="$LD_CERTS_DIR/${hostname}-key.pem"

    if [ -f "$cert_file" ] && [ -f "$key_file" ]; then
        return 0
    fi

    if ! command -v mkcert &> /dev/null; then
        print_error "mkcert nincs telep√≠tve"
        echo "  Telep√≠tsd: sudo pacman -S mkcert nss && mkcert -install"
        return 1
    fi

    print_info "Tan√∫s√≠tv√°ny gener√°l√°sa: $hostname"
    mkcert -cert-file "$cert_file" -key-file "$key_file" \
        "$hostname" "*.${hostname}" localhost 127.0.0.1 ::1 > /dev/null 2>&1

    if [ -f "$cert_file" ]; then
        print_success "Tan√∫s√≠tv√°ny l√©trehozva"
    else
        print_error "Tan√∫s√≠tv√°ny gener√°l√°sa sikertelen"
        return 1
    fi
}

# === PHP verzi√≥ detekt√°l√°s ===

detect_php_version() {
    local project_path="$1"
    local detected=""
    local source=""

    # 1. composer.json
    if [ -f "$project_path/composer.json" ]; then
        detected=$(grep -oP '"php"\s*:\s*"[^"]*(\d+\.\d+)' "$project_path/composer.json" 2>/dev/null | grep -oP '\d+\.\d+' | head -1)
        [ -n "$detected" ] && source="composer.json"
    fi

    # 2. .php-version
    if [ -z "$detected" ] && [ -f "$project_path/.php-version" ]; then
        detected=$(grep -oP '^\d+\.\d+' "$project_path/.php-version" 2>/dev/null | head -1)
        [ -n "$detected" ] && source=".php-version"
    fi

    # 3. .phpversion
    if [ -z "$detected" ] && [ -f "$project_path/.phpversion" ]; then
        detected=$(grep -oP '^\d+\.\d+' "$project_path/.phpversion" 2>/dev/null | head -1)
        [ -n "$detected" ] && source=".phpversion"
    fi

    if [ -n "$detected" ]; then
        echo "$detected|$source"
    else
        echo "$DEFAULT_PHP_VERSION|default"
    fi
}

# === Site kezel√©s ===

serve_project() {
    local hostname="$1"
    local project_path=""
    local project_name=""

    # Ha nincs megadva, aktu√°lis mappa
    if [ -z "$hostname" ]; then
        local current_dir=$(pwd)

        if [[ "$current_dir" == "$PROJECTS_DIR"/* ]]; then
            project_name=$(echo "$current_dir" | sed "s|$PROJECTS_DIR/||" | cut -d'/' -f1)
            project_path="$PROJECTS_DIR/$project_name"
            hostname="${project_name}.test"
        else
            print_error "Nem vagy ~/Codes projekt mapp√°ban"
            echo ""
            echo "  Haszn√°lat:"
            echo "    cd ~/Codes/myproject && ld serve"
            echo "    ld serve myproject"
            return 1
        fi
    else
        # .test v√©gz≈ëd√©s kezel√©se
        if [[ "$hostname" == *.test ]]; then
            project_name="${hostname%.test}"
        else
            project_name="$hostname"
            hostname="${project_name}.test"
        fi
        project_path="$PROJECTS_DIR/$project_name"
    fi

    # Projekt l√©tezik?
    if [ ! -d "$project_path" ]; then
        print_error "Projekt nem tal√°lhat√≥: $project_path"
        echo ""
        cmd_projects
        return 1
    fi

    local site_file="$LD_SITES_DIR/${hostname}.conf"

    if [ -f "$site_file" ]; then
        print_warning "Site m√°r l√©tezik: $hostname"
        return 1
    fi

    # PHP verzi√≥
    local php_info=$(detect_php_version "$project_path")
    local php_version=$(echo "$php_info" | cut -d'|' -f1)
    local php_source=$(echo "$php_info" | cut -d'|' -f2)

    # Document root
    local doc_root="$project_path"
    [ -d "$project_path/public" ] && doc_root="$project_path/public"
    [ -d "$project_path/web" ] && doc_root="$project_path/web"

    # PHP socket
    local php_socket=""
    if [ -S "$PHP_RUN_DIR/php${php_version}-fpm.sock" ]; then
        php_socket="unix/$PHP_RUN_DIR/php${php_version}-fpm.sock"
    else
        print_error "PHP $php_version FPM nem fut"
        echo "  Ind√≠tsd el: ld start"
        return 1
    fi

    generate_cert "$hostname" || return 1

    cat > "$site_file" << EOF
https://${hostname} {
    tls $LD_CERTS_DIR/${hostname}.pem $LD_CERTS_DIR/${hostname}-key.pem
    root * ${doc_root}
    php_fastcgi ${php_socket}
    file_server
    log {
        output file $LD_LOG_DIR/${hostname}.log
    }
    @phpFiles path *.php
    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}
EOF

    echo ""
    print_success "Site l√©trehozva: $project_name"
    echo -e "  ${BLUE}URL:${NC}  https://${hostname}"
    echo -e "  ${BLUE}PHP:${NC}  $php_version ($php_source)"
    echo -e "  ${BLUE}Root:${NC} $doc_root"

    if caddy_is_running; then
        caddy_reload
    else
        print_warning "Caddy nem fut. Ind√≠tsd el: ld start"
    fi
}

remove_site() {
    local hostname="$1"

    if [ -z "$hostname" ]; then
        print_error "Haszn√°lat: ld remove <hostname>"
        return 1
    fi

    [[ "$hostname" != *.test ]] && hostname="${hostname}.test"

    local site_file="$LD_SITES_DIR/${hostname}.conf"

    if [ ! -f "$site_file" ]; then
        print_error "Site nem tal√°lhat√≥: $hostname"
        return 1
    fi

    rm -f "$site_file"
    rm -f "$LD_CERTS_DIR/${hostname}.pem" "$LD_CERTS_DIR/${hostname}-key.pem"

    print_success "Site t√∂r√∂lve: $hostname"

    caddy_is_running && caddy_reload
}

list_sites() {
    echo ""
    print_header "Akt√≠v site-ok"
    echo ""

    local count=$(find "$LD_SITES_DIR" -name "*.conf" 2>/dev/null | wc -l)

    if [ "$count" -eq 0 ]; then
        print_warning "Nincsenek site-ok"
        echo "  Hozz l√©tre egyet: cd ~/Codes/myproject && ld serve"
        echo ""
        return 0
    fi

    for site_file in "$LD_SITES_DIR"/*.conf; do
        [ -f "$site_file" ] || continue

        local hostname=$(basename "$site_file" .conf)
        local backend=""

        if grep -q "php_fastcgi" "$site_file"; then
            local php_ver=$(grep -oP 'php\K[0-9.]+' "$site_file" | head -1)
            backend="PHP $php_ver"
        else
            backend=$(grep -oP 'reverse_proxy \K[^\s]+' "$site_file" | head -1)
        fi

        echo -e "  ${GREEN}üîí${NC} ${BOLD}https://${hostname}${NC} ‚Üí $backend"
    done
    echo ""
}

# === Parancsok ===

cmd_start() {
    echo ""
    print_header "Local Development Environment ind√≠t√°sa"
    echo ""

    # PHP-FPM ind√≠t√°sa
    php_start_all

    # Caddy ind√≠t√°sa
    caddy_start

    echo ""
    print_success "K√∂rnyezet elindult"
    echo ""
}

cmd_stop() {
    echo ""
    print_header "Local Development Environment le√°ll√≠t√°sa"
    echo ""

    caddy_stop
    php_stop_all

    echo ""
    print_success "K√∂rnyezet le√°ll√≠tva"
    echo ""
}

cmd_restart() {
    cmd_stop
    sleep 1
    cmd_start
}

cmd_status() {
    echo ""
    print_header "Local Development Environment"
    echo ""

    # Caddy st√°tusz
    echo -n "  Caddy:   "
    if caddy_is_running; then
        echo -e "${GREEN}‚óè${NC} fut√≥"
    else
        echo -e "${RED}‚óè${NC} le√°ll√≠tva"
    fi

    # PHP st√°tusz
    local php_running=0
    local php_total=0
    for version in $(php_get_versions); do
        php_total=$((php_total + 1))
        php_is_running "$version" && php_running=$((php_running + 1)) || true
    done

    echo -n "  PHP-FPM: "
    if [ "$php_running" -eq "$php_total" ] && [ "$php_total" -gt 0 ]; then
        echo -e "${GREEN}‚óè${NC} $php_running/$php_total fut√≥"
    elif [ "$php_running" -gt 0 ]; then
        echo -e "${YELLOW}‚óè${NC} $php_running/$php_total fut√≥"
    else
        echo -e "${RED}‚óè${NC} le√°ll√≠tva"
    fi

    # Site-ok
    local site_count=$(find "$LD_SITES_DIR" -name "*.conf" 2>/dev/null | wc -l)
    echo -e "  Site-ok: $site_count akt√≠v"

    list_sites
}

cmd_projects() {
    echo ""
    print_header "Projektek ($PROJECTS_DIR)"
    echo ""

    if [ ! -d "$PROJECTS_DIR" ]; then
        print_error "Projekt mappa nem l√©tezik: $PROJECTS_DIR"
        return 1
    fi

    local projects=$(find "$PROJECTS_DIR" -maxdepth 1 -type d -not -path "$PROJECTS_DIR" -printf "%f\n" 2>/dev/null | sort)

    if [ -z "$projects" ]; then
        print_warning "Nincsenek projektek"
        return 0
    fi

    for project in $projects; do
        local served=""
        [ -f "$LD_SITES_DIR/${project}.test.conf" ] && served=" ${GREEN}[akt√≠v]${NC}"
        echo -e "  ${BLUE}‚Ä¢${NC} $project$served"
    done
    echo ""
}

# PHP binary keres√©se verzi√≥ alapj√°n
php_get_bin() {
    local version="$1"
    local php_bin="$PHP_VERSIONS_DIR/php-${version}/php"

    if [ -x "$php_bin" ]; then
        echo "$php_bin"
    elif command -v php &> /dev/null; then
        command -v php
    else
        return 1
    fi
}

# PHP verzi√≥ detekt√°l√°s az aktu√°lis mapp√°b√≥l
php_detect_current() {
    local detected=""
    local source=""

    # 1. composer.json
    if [ -f "composer.json" ]; then
        detected=$(grep -oP '"php"\s*:\s*"[^"]*(\d+\.\d+)' "composer.json" 2>/dev/null | grep -oP '\d+\.\d+' | head -1)
        [ -n "$detected" ] && source="composer.json"
    fi

    # 2. .php-version
    if [ -z "$detected" ] && [ -f ".php-version" ]; then
        detected=$(grep -oP '^\d+\.\d+' ".php-version" 2>/dev/null | head -1)
        [ -n "$detected" ] && source=".php-version"
    fi

    # 3. .phpversion
    if [ -z "$detected" ] && [ -f ".phpversion" ]; then
        detected=$(grep -oP '^\d+\.\d+' ".phpversion" 2>/dev/null | head -1)
        [ -n "$detected" ] && source=".phpversion"
    fi

    if [ -n "$detected" ]; then
        echo "$detected|$source"
    else
        echo "$DEFAULT_PHP_VERSION|default"
    fi
}

# PHP CLI futtat√°sa a megfelel≈ë verzi√≥val
php_run() {
    local php_info=$(php_detect_current)
    local php_version=$(echo "$php_info" | cut -d'|' -f1)
    local php_source=$(echo "$php_info" | cut -d'|' -f2)
    local php_bin=$(php_get_bin "$php_version")

    if [ -z "$php_bin" ]; then
        print_error "PHP $php_version nem tal√°lhat√≥"
        return 1
    fi

    # Ha nincs argumentum, mutassuk a verzi√≥t forr√°ssal
    if [ $# -eq 0 ]; then
        echo -e "${BLUE}PHP $php_version${NC} ($php_source)"
        "$php_bin" -v
        return 0
    fi

    # Futtassuk a PHP-t az argumentumokkal
    exec "$php_bin" "$@"
}

cmd_php() {
    local subcmd="${1:-}"

    # FPM kezel≈ë parancsok
    case "$subcmd" in
        list|ls)
            php_list
            return
            ;;
        fpm)
            shift
            local fpm_cmd="${1:-list}"
            shift 2>/dev/null || true
            case "$fpm_cmd" in
                start)
                    if [ -z "$1" ]; then
                        php_start_all
                    else
                        php_start "$1"
                    fi
                    ;;
                stop)
                    if [ -z "$1" ]; then
                        php_stop_all
                    else
                        php_stop "$1"
                    fi
                    ;;
                restart)
                    if [ -z "$1" ]; then
                        php_stop_all
                        sleep 1
                        php_start_all
                    else
                        php_stop "$1"
                        sleep 1
                        php_start "$1"
                    fi
                    ;;
                *)
                    php_list
                    ;;
            esac
            return
            ;;
        start)
            shift
            if [ -z "$1" ]; then
                php_start_all
            else
                php_start "$1"
            fi
            return
            ;;
        stop)
            shift
            if [ -z "$1" ]; then
                php_stop_all
            else
                php_stop "$1"
            fi
            return
            ;;
        restart)
            shift
            if [ -z "$1" ]; then
                php_stop_all
                sleep 1
                php_start_all
            else
                php_stop "$1"
                sleep 1
                php_start "$1"
            fi
            return
            ;;
    esac

    # Ha nem FPM parancs, akkor CLI wrapper
    php_run "$@"
}

# Composer futtat√°sa a megfelel≈ë PHP verzi√≥val
cmd_composer() {
    local php_info=$(php_detect_current)
    local php_version=$(echo "$php_info" | cut -d'|' -f1)
    local php_source=$(echo "$php_info" | cut -d'|' -f2)
    local php_bin=$(php_get_bin "$php_version")

    if [ -z "$php_bin" ]; then
        print_error "PHP $php_version nem tal√°lhat√≥"
        return 1
    fi

    # Composer keres√©se
    local composer_bin=""

    # 1. Projekt lok√°lis composer.phar
    if [ -f "composer.phar" ]; then
        composer_bin="composer.phar"
    # 2. Rendszer composer
    elif command -v composer &> /dev/null; then
        composer_bin=$(command -v composer)
    # 3. ~/.local/bin/composer
    elif [ -x "$HOME/.local/bin/composer" ]; then
        composer_bin="$HOME/.local/bin/composer"
    # 4. Glob√°lis composer.phar
    elif [ -f "$HOME/.composer/composer.phar" ]; then
        composer_bin="$HOME/.composer/composer.phar"
    else
        print_error "Composer nem tal√°lhat√≥"
        echo "  Telep√≠t√©s: https://getcomposer.org/download/"
        return 1
    fi

    # Ha nincs argumentum, mutassuk a verzi√≥t
    if [ $# -eq 0 ]; then
        echo -e "${BLUE}Composer${NC} + PHP $php_version ($php_source)"
        exec "$php_bin" "$composer_bin" --version
    fi

    # Futtassuk a Composer-t
    exec "$php_bin" "$composer_bin" "$@"
}

cmd_logs() {
    local target="${1:-caddy}"

    case "$target" in
        caddy)
            journalctl --user -u caddy.service -f
            ;;
        php)
            tail -f "$PHP_DIR"/logs/*.log 2>/dev/null || print_warning "Nincs PHP log"
            ;;
        *)
            # Site log
            local logfile="$LD_LOG_DIR/${target}.log"
            [ ! -f "$logfile" ] && logfile="$LD_LOG_DIR/${target}.test.log"

            if [ -f "$logfile" ]; then
                tail -f "$logfile"
            else
                print_error "Log nem tal√°lhat√≥: $target"
            fi
            ;;
    esac
}

# === INSTALL COMMAND ===

install_directories() {
    print_info "K√∂nyvt√°rak l√©trehoz√°sa..."
    mkdir -p "$LD_CONFIG_DIR" "$LD_SITES_DIR" "$LD_CERTS_DIR" "$LD_LOG_DIR"
    mkdir -p "$PHP_DIR" "$PHP_VERSIONS_DIR" "$PHP_RUN_DIR" "$PHP_DIR/logs"
    mkdir -p "$PROJECTS_DIR"
    mkdir -p "$HOME/.config/systemd/user"
    mkdir -p "$HOME/.local/bin"
    print_success "K√∂nyvt√°rak l√©trehozva"
}

install_check_deps() {
    local missing=()

    command -v curl &> /dev/null || missing+=("curl")
    command -v tar &> /dev/null || missing+=("tar")

    if [ ${#missing[@]} -gt 0 ]; then
        print_error "Hi√°nyz√≥ f√ºgg≈ës√©gek: ${missing[*]}"
        echo "  Telep√≠tsd: sudo pacman -S ${missing[*]}"
        return 1
    fi
    return 0
}

install_caddy() {
    echo ""
    print_header "Caddy telep√≠t√©se"

    if [ -x "$CADDY_BIN" ]; then
        print_success "Caddy m√°r telep√≠tve: $("$CADDY_BIN" version 2>/dev/null | head -1)"
    else
        print_info "Caddy telep√≠t√©se..."
        sudo pacman -S --needed --noconfirm caddy || {
            print_error "Caddy telep√≠t√©se sikertelen"
            return 1
        }
    fi

    # Capability be√°ll√≠t√°sa a 80/443 portokhoz
    print_info "Port capability be√°ll√≠t√°sa..."
    sudo setcap 'cap_net_bind_service=+ep' "$CADDY_BIN" 2>/dev/null || {
        print_warning "Capability be√°ll√≠t√°sa sikertelen (sudo sz√ºks√©ges)"
    }

    # Systemd service
    print_info "Systemd service l√©trehoz√°sa..."
    cat > "$HOME/.config/systemd/user/caddy.service" << 'EOF'
[Unit]
Description=Caddy Web Server (ld)
After=network.target

[Service]
Type=simple
ExecStart=/usr/sbin/caddy run --config %h/.config/ld/Caddyfile --adapter caddyfile
ExecReload=/usr/bin/curl -s http://localhost:2019/load -H "Content-Type: text/caddyfile" --data-binary @%h/.config/ld/Caddyfile
Restart=on-failure
RestartSec=5

[Install]
WantedBy=default.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable caddy.service 2>/dev/null || true

    # Caddyfile inicializ√°l√°s
    init_caddyfile

    print_success "Caddy konfigur√°lva"
}

install_mkcert() {
    echo ""
    print_header "mkcert telep√≠t√©se (HTTPS)"

    if command -v mkcert &> /dev/null; then
        print_success "mkcert m√°r telep√≠tve"
    else
        print_info "mkcert telep√≠t√©se..."
        sudo pacman -S --needed --noconfirm mkcert nss || {
            print_error "mkcert telep√≠t√©se sikertelen"
            return 1
        }
    fi

    # CA inicializ√°l√°s
    if [ ! -d "$(mkcert -CAROOT 2>/dev/null)" ] || [ ! -f "$(mkcert -CAROOT)/rootCA.pem" ]; then
        print_info "Helyi CA inicializ√°l√°sa..."
        mkcert -install
    fi

    print_success "mkcert konfigur√°lva"
}

install_dnsmasq() {
    echo ""
    print_header "dnsmasq telep√≠t√©se (.test domain)"

    if command -v dnsmasq &> /dev/null; then
        print_success "dnsmasq m√°r telep√≠tve"
    else
        print_info "dnsmasq telep√≠t√©se..."
        sudo pacman -S --needed --noconfirm dnsmasq || {
            print_error "dnsmasq telep√≠t√©se sikertelen"
            return 1
        }
    fi

    # .test domain konfigur√°ci√≥
    local dnsmasq_conf="/etc/dnsmasq.d/test-tld.conf"
    if [ ! -f "$dnsmasq_conf" ]; then
        print_info ".test domain konfigur√°ci√≥..."
        echo "address=/test/127.0.0.1" | sudo tee "$dnsmasq_conf" > /dev/null
        sudo systemctl enable dnsmasq
        sudo systemctl restart dnsmasq
    fi

    # resolv.conf ellen≈ërz√©s
    if ! grep -q "127.0.0.1" /etc/resolv.conf 2>/dev/null; then
        print_warning "Add hozz√° a 127.0.0.1-et a /etc/resolv.conf-hoz"
        echo "  nameserver 127.0.0.1"
    fi

    print_success "dnsmasq konfigur√°lva"
}

install_php_version() {
    local version="$1"
    local version_dir="$PHP_VERSIONS_DIR/php-${version}"

    if [ -d "$version_dir" ] && [ -x "$version_dir/php" ]; then
        print_warning "PHP $version m√°r telep√≠tve"
        return 0
    fi

    print_info "PHP $version let√∂lt√©se..."

    local arch="x86_64"
    local url="${STATIC_PHP_BASE_URL}/php-${version}-fpm-linux-${arch}.tar.gz"

    local tmp_file=$(mktemp)
    if ! curl -fsSL "$url" -o "$tmp_file" 2>/dev/null; then
        print_error "PHP $version let√∂lt√©se sikertelen"
        print_info "URL: $url"
        rm -f "$tmp_file"
        return 1
    fi

    mkdir -p "$version_dir"
    tar -xzf "$tmp_file" -C "$version_dir" 2>/dev/null || {
        print_error "PHP $version kicsomagol√°sa sikertelen"
        rm -f "$tmp_file"
        return 1
    }
    rm -f "$tmp_file"

    # PHP-FPM konfigur√°ci√≥
    install_php_fpm_config "$version"

    print_success "PHP $version telep√≠tve"
}

install_php_fpm_config() {
    local version="$1"
    local version_dir="$PHP_VERSIONS_DIR/php-${version}"
    local fpm_conf="$version_dir/php-fpm.conf"
    local pool_conf="$version_dir/php-fpm.d/www.conf"

    mkdir -p "$version_dir/php-fpm.d"

    # F≈ë FPM konfig
    cat > "$fpm_conf" << EOF
[global]
pid = $PHP_RUN_DIR/php${version}-fpm.pid
error_log = $PHP_DIR/logs/php${version}-fpm.log
daemonize = yes

include = $version_dir/php-fpm.d/*.conf
EOF

    # Pool konfig
    cat > "$pool_conf" << EOF
[www]
user = $USER
group = $USER

listen = $PHP_RUN_DIR/php${version}-fpm.sock
listen.owner = $USER
listen.group = $USER
listen.mode = 0660

pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3

catch_workers_output = yes
EOF
}

install_php_all() {
    echo ""
    print_header "PHP verzi√≥k telep√≠t√©se"

    local versions=("8.1" "8.2" "8.3" "8.4")

    for version in "${versions[@]}"; do
        install_php_version "$version" || true
    done

    # Systemd service
    print_info "PHP-FPM systemd service l√©trehoz√°sa..."
    cat > "$HOME/.config/systemd/user/php-fpm.service" << 'EOF'
[Unit]
Description=PHP-FPM (ld)
After=network.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=%h/.local/bin/ld php start
ExecStop=%h/.local/bin/ld php stop

[Install]
WantedBy=default.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable php-fpm.service 2>/dev/null || true

    print_success "PHP-FPM konfigur√°lva"
}

install_composer() {
    echo ""
    print_header "Composer telep√≠t√©se"

    local composer_bin="$HOME/.local/bin/composer"

    if [ -x "$composer_bin" ]; then
        print_success "Composer m√°r telep√≠tve: $("$composer_bin" --version 2>/dev/null | head -1)"
        return 0
    fi

    if command -v composer &> /dev/null; then
        print_success "Composer m√°r telep√≠tve (rendszer): $(composer --version 2>/dev/null | head -1)"
        return 0
    fi

    print_info "Composer let√∂lt√©se..."

    local php_bin=$(php_get_bin "$DEFAULT_PHP_VERSION")
    [ -z "$php_bin" ] && php_bin="php"

    curl -sS https://getcomposer.org/installer | "$php_bin" -- --install-dir="$HOME/.local/bin" --filename=composer || {
        print_error "Composer telep√≠t√©se sikertelen"
        return 1
    }

    chmod +x "$composer_bin"
    print_success "Composer telep√≠tve: $HOME/.local/bin/composer"
}

install_linger() {
    echo ""
    print_header "Systemd linger enged√©lyez√©se (boot autostart)"

    if loginctl show-user "$USER" 2>/dev/null | grep -q "Linger=yes"; then
        print_success "Linger m√°r enged√©lyezve"
    else
        print_info "Linger enged√©lyez√©se..."
        loginctl enable-linger "$USER" || sudo loginctl enable-linger "$USER" || {
            print_warning "Linger enged√©lyez√©se sikertelen"
            return 1
        }
        print_success "Linger enged√©lyezve"
    fi
}

install_shell_aliases() {
    echo ""
    print_header "Shell alias-ok"

    echo ""
    echo "Add hozz√° a shell konfigur√°ci√≥dhoz (~/.bashrc vagy ~/.zshrc):"
    echo ""
    echo -e "  ${CYAN}# ld - Local Development${NC}"
    echo -e "  ${CYAN}alias php=\"ld php\"${NC}"
    echo -e "  ${CYAN}alias composer=\"ld composer\"${NC}"
    echo ""
}

cmd_deps() {
    echo "caddy mkcert nss dnsmasq curl tar"
}

cmd_install() {
    local component="${1:-all}"

    echo ""
    print_header "ld - Local Development Environment Installer"
    echo ""

    case "$component" in
        all)
            install_check_deps || return 1
            install_directories
            install_caddy
            install_mkcert
            install_dnsmasq
            install_php_all
            install_composer
            install_linger

            echo ""
            print_header "Telep√≠t√©s k√©sz!"
            echo ""
            echo "  Ind√≠t√°s:  ld start"
            echo "  St√°tusz:  ld status"
            echo "  Projekt:  cd ~/Codes/myapp && ld serve"
            echo ""

            install_shell_aliases
            ;;
        php)
            shift 2>/dev/null || true
            if [ -n "$1" ]; then
                install_php_version "$1"
            else
                install_php_all
            fi
            ;;
        caddy)
            install_caddy
            ;;
        mkcert)
            install_mkcert
            ;;
        dnsmasq|dns)
            install_dnsmasq
            ;;
        composer)
            install_composer
            ;;
        *)
            echo "Haszn√°lat: ld install [komponens]"
            echo ""
            echo "Komponensek:"
            echo "  all       Teljes telep√≠t√©s (alap√©rtelmezett)"
            echo "  php [ver] PHP verzi√≥k (vagy egy specifikus)"
            echo "  caddy     Caddy webszerver"
            echo "  mkcert    mkcert (HTTPS)"
            echo "  dnsmasq   dnsmasq (.test domain)"
            echo "  composer  Composer"
            ;;
    esac
}

cmd_help() {
    cat <<EOF
${BOLD}${CYAN}ld${NC} - Local Development Environment Manager v${VERSION}

${BOLD}HASZN√ÅLAT${NC}
  ld <parancs> [opci√≥k]

${BOLD}K√ñRNYEZET KEZEL√âS${NC}
  ${BLUE}start${NC}              Minden szolg√°ltat√°s ind√≠t√°sa (Caddy + PHP-FPM)
  ${BLUE}stop${NC}               Minden szolg√°ltat√°s le√°ll√≠t√°sa
  ${BLUE}restart${NC}            √öjraind√≠t√°s
  ${BLUE}status${NC}             √Ållapot megjelen√≠t√©se

${BOLD}SITE KEZEL√âS${NC}
  ${BLUE}serve${NC} [projekt]    Projekt kiszolg√°l√°sa (vagy aktu√°lis mappa)
  ${BLUE}remove${NC} <host>      Site elt√°vol√≠t√°sa
  ${BLUE}list${NC}               Akt√≠v site-ok list√°z√°sa
  ${BLUE}projects${NC}           El√©rhet≈ë projektek list√°z√°sa

${BOLD}PHP & COMPOSER (alias php="ld php" composer="ld composer")${NC}
  ${BLUE}php${NC}                PHP verzi√≥ megjelen√≠t√©se (projekt alapj√°n)
  ${BLUE}php${NC} <args>         PHP futtat√°sa a megfelel≈ë verzi√≥val
  ${BLUE}php artisan${NC} ...    Laravel Artisan
  ${BLUE}composer${NC}           Composer verzi√≥ (projekt PHP-vel)
  ${BLUE}composer${NC} <args>    Composer futtat√°sa (install, update, stb.)

${BOLD}PHP-FPM KEZEL√âS${NC}
  ${BLUE}php list${NC}           Telep√≠tett PHP verzi√≥k
  ${BLUE}php start${NC} [ver]    PHP-FPM ind√≠t√°sa
  ${BLUE}php stop${NC} [ver]     PHP-FPM le√°ll√≠t√°sa
  ${BLUE}php restart${NC} [ver]  PHP-FPM √∫jraind√≠t√°sa

${BOLD}TELEP√çT√âS${NC}
  ${BLUE}install${NC}            Teljes k√∂rnyezet telep√≠t√©se
  ${BLUE}install php${NC} [ver]  PHP verzi√≥k telep√≠t√©se
  ${BLUE}install composer${NC}   Composer telep√≠t√©se

${BOLD}EGY√âB${NC}
  ${BLUE}logs${NC} [target]      Logok megjelen√≠t√©se (caddy/php/site)
  ${BLUE}help${NC}               S√∫g√≥ megjelen√≠t√©se
  ${BLUE}version${NC}            Verzi√≥ megjelen√≠t√©se

${BOLD}P√âLD√ÅK${NC}
  ld start                      # K√∂rnyezet ind√≠t√°sa
  cd ~/Codes/myapp && ld serve  # Projekt kiszolg√°l√°sa
  ld serve myapp                # Projekt kiszolg√°l√°sa n√©v alapj√°n

  cd ~/Codes/myapp && ld php    # PHP verzi√≥ (8.4 ha composer.json-ben)
  ld php artisan migrate        # Laravel migration a megfelel≈ë PHP-vel
  ld composer install           # Composer a megfelel≈ë PHP-vel
  ld composer update            # Composer update

  ld php list                   # PHP-FPM verzi√≥k
  ld logs myapp.test            # Site log

${BOLD}PHP VERZI√ì FELISMER√âS${NC}
  1. composer.json require.php
  2. .php-version f√°jl
  3. .phpversion f√°jl
  4. Alap√©rtelmezett: $DEFAULT_PHP_VERSION

${BOLD}F√ÅJLOK${NC}
  Config:   $LD_CONFIG_DIR
  Sites:    $LD_SITES_DIR
  Certs:    $LD_CERTS_DIR
  Logs:     $LD_LOG_DIR
  PHP:      $PHP_DIR
  Projects: $PROJECTS_DIR
EOF
}

# === F≈ë bel√©p√©si pont ===

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true

    case "$cmd" in
        start)          cmd_start ;;
        stop)           cmd_stop ;;
        restart)        cmd_restart ;;
        status|st)      cmd_status ;;
        serve)          serve_project "$@" ;;
        remove|rm)      remove_site "$@" ;;
        list|ls)        list_sites ;;
        sites)          list_sites ;;
        projects|proj)  cmd_projects ;;
        php)            cmd_php "$@" ;;
        composer)       cmd_composer "$@" ;;
        install)        cmd_install "$@" ;;
        logs|log)       cmd_logs "$@" ;;
        reload)         caddy_reload ;;
        help|--help|-h) cmd_help ;;
        version|-v|--version) echo "ld version $VERSION" ;;
        *)
            print_error "Ismeretlen parancs: $cmd"
            echo "  Haszn√°lat: ld help"
            exit 1
            ;;
    esac
}

main "$@"
